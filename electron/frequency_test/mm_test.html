<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined">
        <link rel="stylesheet" href="./mm_test.css">

        <script>
            const SerialPort = require('serialport');
            const Readline = require('@serialport/parser-readline');
            const storage = require('electron-json-storage');
            const iro = require('@jaames/iro');
            const $ = require('jquery');
            require('bootstrap');
            require('popper.js');

            const parser = new Readline();
            var port = new SerialPort(".", { autoOpen: false });

            var curHue = 0;
            var changeColor = false;
            var send = false;
            const cycleDuration = 5000;
            var colorInterval = null;
            var transInterval = null;

            var t0 = 0;

            window.setVariableInterval = function(callbackFunc, timing) {
                var variableInterval = {
                    interval: timing,
                    callback: callbackFunc,
                    stopped: false,
                    runLoop: function() {
                        if (variableInterval.stopped) return;
                        var result = variableInterval.callback.call(variableInterval);
                        if (typeof result == 'number')
                        {
                            if (result === 0) return;
                            variableInterval.interval = result;
                        }
                        variableInterval.loop();
                    },
                    stop: function() {
                        this.stopped = true;
                        window.clearTimeout(this.timeout);
                    },
                    start: function() {
                        this.stopped = false;
                        return this.loop();
                    },
                    loop: function() {
                        this.timeout = window.setTimeout(this.runLoop, this.interval);
                        return this;
                    }
                };
                return variableInterval.start();
            };

            window.onerror = (errorMsg, url, lineNumber) => {
                document.getElementById("error-modal-text").innerText = `
                    Ein unbekannter Fehler ist aufgetreten. Bitte starten Sie das Programm neu!
                    Sollte dies keine Wirkung zeigen, suchen Sie bitte den nächstgelegenen Computer-Menschen
                    auf oder schreien Sie laut um Hilfe. Hier die Fehlermeldung:\n
                    ${errorMsg}\n
                    Zeile ${lineNumber} in folgender Datei:\n
                    ${url}
                `;
                $("#error-modal").modal("show");
                return false;
            }

            /**
             * Converts an HSL color value to RGB. Conversion formula
             * adapted from http://en.wikipedia.org/wiki/HSL_color_space.
             * Assumes h, s, and l are contained in the set [0, 1] and
             * returns r, g, and b in the set [0, 255].
             *
             * @param   {number}  h       The hue
             * @param   {number}  s       The saturation
             * @param   {number}  l       The lightness
             * @return  {Array}           The RGB representation
             */
            function hslToRgb(hsl){
                var h = hsl.h / 360, s = hsl.s, l = hsl.l;
                var r, g, b;

                if(s == 0) {
                    r = g = b = l; // achromatic
                } else {
                    var hue2rgb = function hue2rgb(p, q, t){
                        if(t < 0) t += 1;
                        if(t > 1) t -= 1;
                        if(t < 1/6) return p + (q - p) * 6 * t;
                        if(t < 1/2) return q;
                        if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                        return p;
                    }

                    var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    var p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }

                return {r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255)};
            }
            

            async function init() {
                // get all devices connected
                const ports = await SerialPort.list();
                console.log('ports found:')
                console.log(ports);
                arduinos = ports.filter(el => {
                    return el.hasOwnProperty('manufacturer') && typeof el.manufacturer === 'string' && el.manufacturer.startsWith('Arduino')
                });
                if(arduinos.length === 0) {
                    console.log(`Es wurde kein Arduino zum Steuern der LEDs gefunden. Bitte schließen Sie ein Gerät an und starten Sie das Programm neu.`);
                } else if(arduinos.length > 1) {
                    console.log(`Es wurden ${arduinos.length} Arduinos zum Steuern der LEDs gefunden. Bitte entfernen Sie ein oder mehrere Geräte und starten Sie das Programm neu.`);
                } else {
                    // if only one device is connected, enable communication
                    port = new SerialPort(arduinos[0].path, { baudRate: 115200 });
                    port.pipe(parser);
                    parser.on('data', line => {
                        console.log(`> ${line}`);
                        line = line.substring(0, line.length - 1);

                        if(line === 'received') {
                            console.log(1000/(performance.now() - t0) + " Hz");
                        }
                    });
                    port.on('open', () => {
                        console.log(`Verbunden mit ${arduinos[0].path}`.replace(/\n/g, ""));
                    });
                }
            }

            

            function updateGUI1() {
                const hslColor = {h: curHue, s: 1, l: 0.5}
                const hslGrey = {h: curHue, s: 0, l: 0.5}
                const rgb = hslToRgb(hslColor);

                // set color of icon
                var colorDiv = document.getElementById("color");
                colorDiv.style = `background-color: rgb(${rgb.r},${rgb.g},${rgb.b})`;
                // colorDiv.style = `background-color: hsl(${curHue},100%,50%)`;

                // display non-rgb leds as grayscale
                var isRgb = Array(6).fill(true).concat(Array(5).fill(false));
                var outputData = Array(28).fill(0);
                var channelIndexRgb = 4;
                var channelIndexWhite = 11;

                for (let index = 0; index < 11; index++) {
                    // set data to output to serial port
                    if(isRgb[index]) {
                        if(index === 0) {
                            // channels r and b of first rgb led are switched
                            outputData[channelIndexRgb] = rgb.b;
                            outputData[channelIndexRgb + 1] = rgb.g;
                            outputData[channelIndexRgb + 2] = rgb.r;
                        } else {
                            outputData[channelIndexRgb] = rgb.r;
                            outputData[channelIndexRgb + 1] = rgb.g;
                            outputData[channelIndexRgb + 2] = rgb.b;
                        }
                        channelIndexRgb += 4;
                    } else {
                        outputData[channelIndexWhite] = 255;
                        channelIndexWhite += 4;
                    }
                }
                
                // write data to serial port
                port.write(outputData.join(",") + "\n", error => {
                    if(error)
                        throw error;
                });
            }

            function updateGUI() {
                const hslColor = {h: curHue, s: 1, l: 0.5}
                const hslGrey = {h: curHue, s: 0, l: 0.5}
                const rgb = hslToRgb(hslColor);

                // set color of icon
                var colorDiv = document.getElementById("color");
                colorDiv.style = `background-color: rgb(${rgb.r},${rgb.g},${rgb.b})`;

                var data = "00000000 0000FF 00 FF0000 FF FF0000 FF FF0000 FF FF0000 FF FF0000 FF";
                data = data.replace(/ /g,'');
                
                // write data to serial port
                port.write(data + "\n", error => {
                    if(error)
                        throw error;
                });
            }

            function setColorRotation() {
                if(changeColor) {
                    clearInterval(colorInterval);
                    document.getElementById('startspan').innerHTML = 'Start Color Change';
                } else {
                    colorInterval = setInterval(() => {curHue = (curHue + 1) % 360}, cycleDuration / 360);
                    document.getElementById('startspan').innerHTML = 'Stop Color Change';
                }
                changeColor = !changeColor;
            }

            function sendStop() {
                // write data to serial port
                port.write("A", error => {
                    if(error)
                        throw error;
                });
            }

            function setTransmission() {
                if(send) {
                    if(transInterval != null) {
                        transInterval.stop();
                    }
                    document.getElementById('transspan').innerHTML = 'Start Transmission';
                } else {
                    if(transInterval == null) {
                        transInterval = setVariableInterval(() => {
                            updateGUI();
                            const frequency = document.getElementById("linSlide").value;
                            document.getElementById('freq').innerHTML = frequency + " Hz";
                            return 1000 / frequency;
                        }, 1);
                    } else {
                        transInterval.start();
                    }
                    document.getElementById('transspan').innerHTML = 'Stop Transmission';
                }
                send = !send;
                
                // t0 = performance.now();
                // updateGUI();
            }

        </script>
        
        <title>LED Controller</title>
    </head>
    <body onload="init()">
        <div class="container">
            <input type="range" min="1" max="300" value="1" class="slider" id="linSlide">
            <div id="freq">Frequenz</div>
            <div id="color"></div>
            <button type="button" class="btn btn-success">
                <span id="startspan" onclick="setColorRotation()">Start Color Change</span>
            </button>
            <button type="button" class="btn btn-success">
                <span id="stopspan" onclick="sendStop()">Send Stop Char</span>
            </button>
            <button type="button" class="btn btn-success">
                <span id="transspan" onclick="setTransmission()">Start Transmission</span>
            </button>
        </div>


        
        <!-- popup warning for all errors -->
        <div id="error-modal" class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Fehler</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p id="error-modal-text">Fehler oder wat?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="window.location.reload()">Neustart</button>
                        <button type="button" class="btn btn-danger" onclick="window.close()">Beenden</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Schlie&szlig;en</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>